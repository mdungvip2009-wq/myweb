<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" />
<title>BO Helper — {{ symbol }}</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/trading-icons.css') }}">
<style>
/* ========= Buttons: icon text BUY/SELL ========= */
.btn-icon-wrapper{display:flex;align-items:center;justify-content:center;width:100%;height:100%}
.btn-icon-wrapper .trading-icon{
  width:48px;height:28px;border-radius:8px;font-size:12px;font-weight:900;letter-spacing:.5px;position:relative;
  display:flex;align-items:center;justify-content:center;text-transform:uppercase;color:#fff;
}
.buy-icon-text::after{content:"BUY"}
.sell-icon-text::after{content:"SELL"}

/* ========= Theme / Base ========= */
:root{
  --bg:#0b1320; --bg2:#0a1223;
  --card:#0f1f35; --card2:#102645;
  --accent:#2dd4bf; --brand:#34c759; --sell:#ff4d4f;
  --muted:#9aa3ab; --text:#eaf2ff; --text-soft:#cfe0ff;
  --line:#183558; --radius:16px;

  /* widths for table columns */
  --w-time:38%;
  --w-side:16%;
  --w-amt:14%;
  --w-res:20%;
  --w-id:12%;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  background:linear-gradient(180deg,var(--bg),var(--bg2));
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  position:relative;overflow-x:hidden;
}

/* ====== animated bg (mềm) ====== */
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:
    radial-gradient(circle at 20% 80%, rgba(45,212,191,.08) 0%, transparent 60%),
    radial-gradient(circle at 80% 20%, rgba(52,199,89,.06) 0%, transparent 60%),
    radial-gradient(circle at 40% 40%, rgba(255,77,79,.04) 0%, transparent 60%),
    radial-gradient(circle at 60% 10%, rgba(138,43,226,.03) 0%, transparent 60%);
  animation:floatingParticles3D 45s ease-in-out infinite;
}
@keyframes floatingParticles3D{
  0%,100%{transform:translateY(0) translateX(0) rotate(0) scale(1)}
  25%{transform:translateY(-15px) translateX(8px) rotate(1deg) scale(1.02)}
  50%{transform:translateY(12px) translateX(-10px) rotate(-.5deg) scale(.98)}
  75%{transform:translateY(-8px) translateX(5px) rotate(.5deg) scale(1.01)}
}
body::after{
  content:'';position:fixed;top:15%;right:8%;width:120px;height:120px;pointer-events:none;z-index:0;
  background:conic-gradient(from 0deg, rgba(45,212,191,.15), rgba(52,199,89,.08), rgba(45,212,191,.15));
  border-radius:30% 70% 70% 30% / 30% 30% 70% 70%;animation:morphingShape 35s ease-in-out infinite;
}
@keyframes morphingShape{
  0%,100%{border-radius:30% 70% 70% 30% / 30% 30% 70% 70%;transform:rotate(0) scale(1);opacity:.4}
  25%{border-radius:58% 42% 75% 25% / 76% 46% 54% 24%;transform:rotate(90deg) scale(1.1);opacity:.6}
  50%{border-radius:50% 50% 25% 75% / 25% 75% 25% 75%;transform:rotate(180deg) scale(.9);opacity:.3}
  75%{border-radius:25% 75% 50% 50% / 75% 25% 75% 25%;transform:rotate(270deg) scale(1.05);opacity:.5}
}

.hidden{display:none!important}
.noscroll{overflow:hidden}

/* ====== Containers / cards ====== */
.wrap{max-width:560px;margin:12px auto 84px;padding:0 14px;position:relative;padding-top:calc(56px + env(safe-area-inset-top) + 12px);z-index:1}
.card{
  background:linear-gradient(180deg,var(--card),var(--card2));
  border:1px solid var(--line);border-radius:var(--radius);padding:18px;
  box-shadow:0 12px 40px rgba(0,0,0,.35);
  content-visibility:auto;contain-intrinsic-size:400px;position:relative;overflow:hidden;
  backdrop-filter:blur(10px);transition:all .3s cubic-bezier(.4,0,.2,1);animation:cardFadeIn .6s ease-out;
}
@keyframes cardFadeIn{0%{opacity:0;transform:translateY(20px) scale(.95)}100%{opacity:1;transform:translateY(0) scale(1)}}
.card::before{
  content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
  background:linear-gradient(90deg, transparent, rgba(45,212,191,.05), transparent);
  animation:cardShimmer 6s infinite;pointer-events:none;
}
@keyframes cardShimmer{0%{left:-100%}100%{left:100%}}
.card:hover{transform:translateY(-1px);box-shadow:0 15px 45px rgba(0,0,0,.4),0 0 0 1px rgba(45,212,191,.08);border-color:rgba(45,212,191,.2)}

.row{display:flex;gap:12px;align-items:center}
.col{flex:1}
.title{font-weight:900;font-size:22px;text-align:center;margin:8px 0 10px}
.big{font-size:30px;font-weight:900;text-align:center;margin:6px 0 4px;min-height:36px}
.ratio{margin-top:8px;text-align:center;font-weight:800}
.ratio .chip{display:inline-block;padding:8px 14px;border-radius:999px;background:#063a35;color:#9ff5e9;border:1px solid #136c63}

/* ====== Advice: center tuyệt đối + CSS loader ====== */
.advice-wrap{min-height:240px;display:grid;place-items:center}
.advice-frame{position:relative;width:220px;height:220px;margin:0 auto}
#advice-spin{
  position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  width:160px;height:160px;display:flex;align-items:center;justify-content:center;
  z-index:2;pointer-events:none;
}
#advice-img{
  position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  width:220px;height:220px;object-fit:contain;border:none;background:transparent;
  transition:opacity .22s ease;z-index:1;
}
#advice-guide{z-index:3;font-size:16px;font-weight:700;color:#ff8c42;text-align:center}
.advice-hidden{opacity:0;pointer-events:none}

/* Loader rings */
.ai-loader{position:relative;width:160px;height:160px;display:flex;align-items:center;justify-content:center}
.ai-loader .ring{position:absolute;inset:0;border:6px solid rgba(45,212,191,.15);border-top-color:#2dd4bf;border-radius:50%;animation:spin 1.2s linear infinite}
.ai-loader .ring:nth-child(2){inset:12px;border-color:rgba(255,140,66,.15);border-left-color:#ff8c42;animation-direction:reverse}
.ai-loader .ring:nth-child(3){inset:24px;border-color:rgba(255,255,255,.1);border-bottom-color:#fff;animation-duration:1.6s}
@keyframes spin{to{transform:rotate(360deg)}}
.ai-loader-text{font-weight:700;font-size:14px;color:#cfe0ff;text-align:center;line-height:1.3;max-width:200px}

/* ====== Inputs & Buttons ====== */
label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px;font-weight:600;transition:color .3s ease}
input,select{
  width:100%;height:46px;border-radius:12px;border:2px solid #1d334f;
  background:rgba(9,26,45,.8);color:#fff;padding:0 12px;font-size:16px;outline:none;
  transition:all .3s cubic-bezier(.4,0,.2,1);backdrop-filter:blur(10px);
}
input:focus,select:focus{border-color:var(--accent);background:rgba(9,26,45,.95);box-shadow:0 0 0 4px rgba(45,212,191,.1),0 8px 25px rgba(45,212,191,.15);transform:translateY(-1px)}
input::placeholder{color:#7692b0;transition:opacity .3s ease}
input:focus::placeholder{opacity:.7}

button{
  width:100%;height:52px;border-radius:14px;border:0;color:#fff;font-size:18px;font-weight:800;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:10px;position:relative;overflow:hidden;
  transition:all .3s cubic-bezier(.4,0,.2,1);
}
button::before{
  content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);transition:left .6s ease;
}
button:hover::before{left:100%}
button:active{transform:scale(.985)}
button:hover{transform:translateY(-2px)}

.btn-buy{background:linear-gradient(135deg,#36d46a,#2ab95c);box-shadow:0 8px 25px rgba(54,212,106,.3)}
.btn-buy:hover{box-shadow:0 12px 35px rgba(54,212,106,.4)}
.btn-sell{background:linear-gradient(135deg,#ff6265,#ef4444);box-shadow:0 8px 25px rgba(255,98,101,.3)}
.btn-sell:hover{box-shadow:0 12px 35px rgba(255,98,101,.4)}
.btn-icon{width:22px;height:22px;display:block;border-radius:4px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3))}
.btn-blocked{pointer-events:none;filter:grayscale(35%) brightness(.7);opacity:.55;transform:none!important}

/* Hàng nút BUY/SELL cân nhau */
.row.btn-row{align-items:stretch}
.row.btn-row>button{flex:1 1 0;height:56px}

/* ====== Tables (đều bằng colgroup) ====== */
table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
th,td{padding:10px 8px;text-align:left;border-bottom:1px dashed #1e3c62;font-size:13px;vertical-align:top;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
th{color:#c7d2de;font-weight:700}
.center{text-align:center}
.mono{font-variant-numeric:tabular-nums}
.pill-up{color:#053b25;background:#0adba9;padding:2px 7px;border-radius:999px;font-weight:800}
.pill-dn{color:#3a0a11;background:#ffb3b6;padding:2px 7px;border-radius:999px;font-weight:800}
.pnl-pos{color:#2dd4bf;font-weight:700}
.pnl-neg{color:#ff6b6b;font-weight:700}
.muted{color:var(--muted)}

.history-table col.col-time{width:var(--w-time)}
.history-table col.col-side{width:var(--w-side)}
.history-table col.col-amt{width:var(--w-amt)}
.history-table col.col-res{width:var(--w-res)}
.history-table col.col-id{width:var(--w-id)}

/* cỡ chữ co dãn khi tràn */
.table-tight th,.table-tight td{font-size:clamp(10px,2.8vw,13px);padding:8px 6px}
@media(min-width:768px){
  .table-tight th,.table-tight td{font-size:13px}
  .table-tight.small-1 th,.table-tight.small-1 td{font-size:12px}
  .table-tight.small-2 th,.table-tight.small-2 td{font-size:11px}
  .table-tight.small-3 th,.table-tight.small-3 td{font-size:10px}
  .table-tight.small-4 th,.table-tight.small-4 td{font-size:9.5px}
}
/* ID nhỏ hơn */
.id-cell{font-size:clamp(9px,2.4vw,12px)}
.copyable{cursor:copy}

/* Mobile: ưu tiên thêm chỗ cho Time + ID */
@media(max-width:420px){
  :root{
    --w-time:40%;
    --w-side:15%;
    --w-amt:14%;
    --w-res:16%;
    --w-id:15%;
  }
}

/* ====== Header / Sidebar (safe-area iOS) ====== */
.main-header{
  position:fixed;top:0;left:0;right:0;
  height:calc(56px + env(safe-area-inset-top));
  padding:env(safe-area-inset-top) 14px 0 14px;
  background:var(--bg);border-bottom:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between;z-index:110
}
.icon-btn{position:relative;width:34px;height:34px;border:none;background:#1a2a40;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;padding:6px 0;gap:4px}
.icon-btn span{display:block;width:20px;height:2px;background:#fff;border-radius:2px}
.header-user-info{display:flex;align-items:center;gap:12px}
.balance-item{display:flex;align-items:center;gap:8px;background:var(--card);padding:8px 12px;border-radius:12px;border:1px solid var(--line)}
.wallet-icon{width:20px;height:20px;color:var(--muted)}
.balance-value{font-size:14px;font-weight:700;color:var(--text)}
.balance-label{font-size:11px;color:var(--muted);margin-top:-2px}
.user-profile{display:flex;align-items:center;gap:10px;background:var(--card);padding:8px 12px;border-radius:12px;border:1px solid var(--line)}
.avatar{width:32px;height:32px;border-radius:50%;overflow:hidden;border:2px solid var(--line)}
.avatar img{width:100%;height:100%;object-fit:cover}
@media(max-width:420px){.balance-label{display:none}.balance-value{font-size:13px}.header-user-info{gap:8px}}
@media(min-width:768px){.header-user-info{margin-left:auto}}

.sidebar{position:fixed;top:0;left:0;height:100dvh;width:84vw;max-width:320px;background:#0f1b2b;border-right:1px solid #173152;
  transform:translateX(-100%);transition:transform .25s ease;z-index:145;display:flex;flex-direction:column;gap:12px;
  padding:calc(env(safe-area-inset-top,0px) + 14px) 14px 18px}
.sidebar.show{transform:translateX(0)}
.menu-item{display:block;width:100%;padding:12px 14px;border-radius:14px;background:#213247;color:#e8f2ff;font-weight:800;text-decoration:none;border:1px solid #2a3f5e}
.menu-logout{background:#2a3b54;color:#ffd9d9}
.menu-item,.menu-item:link,.menu-item:visited,.menu-item:hover,.menu-item:active,.menu-item:focus{text-decoration:none!important}
.menu-item{-webkit-tap-highlight-color:transparent}
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;z-index:140;transition:opacity .25s ease}
.backdrop.show{opacity:1;pointer-events:auto}
</style>
</head>
<body>

<!-- HEADER -->
<header class="main-header">
  <button class="icon-btn" id="btn-menu" aria-label="Mở menu"><span></span><span></span><span></span></button>
  <div class="header-user-info">
    <div class="balance-item">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" class="wallet-icon"><path d="M22 12v5c0 3-2 5-5 5H7c-3 0-5-2-5-5v-5c0-2.72 1.64-4.62 4.19-4.94.26-.04.53-.06.81-.06h10c.26 0 .51.01.75.05C20.33 7.35 22 9.26 22 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M17.751 7.05c-.24-.04-.49-.05-.75-.05h-10c-.28 0-.55.02-.81.06.14-.28.34-.54.58-.78l3.25-3.26a3.525 3.525 0 0 1 4.96 0l1.75 1.77c.64.63.98 1.43 1.02 2.26ZM22 12.5h-3c-1.1 0-2 .9-2 2s.9 2 2 2h3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div><div class="balance-value">$<span id="real-balance">0</span></div><div class="balance-label">TK Thực</div></div>
    </div>
    <div class="balance-item">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" class="wallet-icon"><path d="M22 12v5c0 3-2 5-5 5H7c-3 0-5-2-5-5v-5c0-2.72 1.64-4.62 4.19-4.94.26-.04.53-.06.81-.06h10c.26 0 .51.01.75.05C20.33 7.35 22 9.26 22 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M17.751 7.05c-.24-.04-.49-.05-.75-.05h-10c-.28 0-.55.02-.81.06.14-.28.34-.54.58-.78l3.25-3.26a3.525 3.525 0 0 1 4.96 0l1.75 1.77c.64.63.98 1.43 1.02 2.26ZM22 12.5h-3c-1.1 0-2 .9-2 2s.9 2 2 2h3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div><div class="balance-value">$<span id="demo-balance">0</span></div><div class="balance-label">TK Demo</div></div>
    </div>
    <div class="user-profile"><div class="avatar"><img src="https://img.favpng.com/17/24/10/computer-icons-user-profile-male-avatar-png-favpng-jhVtWQQbMdbcNCahLZztCF5wk.jpg" alt="Avatar"></div></div>
  </div>
</header>

<!-- Backdrop & Sidebar -->
<div id="backdrop" class="backdrop" aria-hidden="true"></div>
<nav class="sidebar" id="sidebar" aria-label="Menu">
  <a href="/" class="menu-item">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="margin-right:8px">
      <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
    </svg>
    Bảng Điều Khiển
  </a>
  <a href="/aidudoan" class="menu-item">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="margin-right:8px">
      <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"/>
    </svg>
    AI Dự Đoán
  </a>
  <a href="/top-expert" class="menu-item">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="margin-right:8px">
      <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
    </svg>
    Top Chuyên Gia
  </a>
  <a href="/copytrade" class="menu-item">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="margin-right:8px">
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
    </svg>
    Copytrade
  </a>
  <button class="menu-item menu-logout" id="btn-logout" type="button">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="margin-right:8px">
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/>
    </svg>
    Đăng xuất
  </button>
</nav>

<div class="wrap">
  <!-- Advice / Ratio -->
  <div class="card" style="text-align:center;">
    <div class="title">AI Agent 5.0</div>
    <div id="advice" class="big advice-wrap">
      <div class="advice-frame">
        <div id="advice-guide" class="advice-hidden">Bạn Hãy Đặt <span id="advice-side">BUY</span></div>

        <!-- Spinner (CSS) -->
        <div id="advice-spin" class="ai-loader">
          <div class="ring"></div><div class="ring"></div><div class="ring"></div>
        </div>

        <!-- Ảnh BUY/SELL -->
        <img id="advice-img" class="advice-hidden" alt="">
      </div>
    </div>
    <div class="ratio"><span id="ratio" class="chip hidden">Ratio: 70%</span></div>
  </div>

  <!-- Controls -->
  <div class="card" style="margin-top:12px">
    <div class="row">
      <div class="col">
        <label>Loại tài khoản</label>
        <select id="type_mode">
          <option value="live" {{ 'selected' if type_mode=='live' else '' }}>Tài khoản Thực</option>
          <option value="demo" {{ 'selected' if type_mode=='demo' else '' }}>Tài khoản Demo</option>
        </select>
      </div>
      <div class="col">
        <label>Số tiền ($)</label>
        <input id="amount" type="text" inputmode="decimal" value="10" placeholder="VD: 10.00">
      </div>
    </div>
    <div class="row btn-row" style="gap:12px;margin-top:12px">
      <button id="btn-sell" class="btn-sell">
        <div class="btn-icon-wrapper"><div class="trading-icon sell-icon-text"></div></div>
      </button>
      <button id="btn-buy" class="btn-buy">
        <div class="btn-icon-wrapper"><div class="trading-icon buy-icon-text"></div></div>
      </button>
    </div>
    <div id="msg" class="msg"></div>
  </div>

  <!-- Pending -->
  <div class="card" style="margin-top:12px">
    <div class="section-title">Đang chờ kết quả</div>
    <div class="muted">Các lệnh PENDING hiện tại.</div>
    <table id="pending-table" class="history-table table-tight">
      <colgroup>
        <col class="col-time"><col class="col-side"><col class="col-amt"><col class="col-res"><col class="col-id">
      </colgroup>
      <thead><tr><th>Thời gian</th><th class="center">Side</th><th class="center">$</th><th class="center">Trạng thái</th><th class="mono center">ID</th></tr></thead>
      <tbody id="pending-body"><tr><td colspan="5" class="center muted">Đang tải…</td></tr></tbody>
    </table>
  </div>

  <!-- History -->
  <div class="card" style="margin-top:12px">
    <div class="section-title">Lịch sử gần đây</div>
    <div class="muted">Hiển thị 10 lệnh mới nhất của hôm nay.</div>
    <table id="hist-table" class="history-table table-tight">
      <colgroup>
        <col class="col-time"><col class="col-side"><col class="col-amt"><col class="col-res"><col class="col-id">
      </colgroup>
      <thead><tr><th>Thời gian</th><th class="center">Side</th><th class="center">$</th><th class="center">Kết quả</th><th class="mono center">ID</th></tr></thead>
      <tbody id="hist-body"><tr><td colspan="5" class="center muted">Đang tải…</td></tr></tbody>
    </table>
  </div>
</div>

<script>
  const MEDIA = {
    BUY:  "{{ url_for('static', filename='buy.png') }}",
    SELL: "{{ url_for('static', filename='sell.png') }}"
  };
</script>

<script>
/* ===== Auth ===== */
const params = new URLSearchParams(window.location.search);
const token = localStorage.getItem('token') || params.get('token');
if(!token){ location.replace('/login'); } else { localStorage.setItem('token', token); }

/* ===== Helpers ===== */
function isMobile(){ return window.matchMedia('(max-width: 480px)').matches; }
function redirectLogin(){ try{ localStorage.removeItem('token'); sessionStorage.clear(); }catch{} location.replace('/login'); }
async function apiFetch(url, options = {}){ const r = await fetch(url, options); if(r.status===401){redirectLogin(); throw new Error('Unauthorized');} return r; }
const withAuth = (opt={}) => { opt.headers=Object.assign({'X-Token':token,'Authorization':`Bearer ${token}`}, opt.headers||{}); return opt; };
const toNum = v => Number(String(v).replace(",", ".").trim() || "0");
const money = n => { const x=Number(n)||0; return x%1===0 ? x.toString() : x.toFixed(2); };

/* Time format compact */
function compactTime(t){
  if(!t) return '';
  const d=new Date(t);
  if(!isNaN(d)){
    return d.toLocaleString('vi-VN',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit',hour12:false});
  }
  // fallback string
  let result=String(t);
  result=result.replace(/(\d{1,2}\/\d{1,2})\/\d{2,4}/,'$1'); // drop year
  result=result.replace(/BTCUSDT/g,'');
  if(isMobile()){
    result=result.replace(/(\d{1,2}\/\d{1,2}).+?(\d{1,2}):(\d{2}).*/,'$1 $2:$3');
  }
  return result.trim();
}

/* Short ID: take last 4 */
function shortId(val){ const s=String(val??''); return s.length<=4?s:s.slice(-4); }

/* Copy */
function copyText(text){
  if(!text) return;
  if(navigator.clipboard?.writeText){
    navigator.clipboard.writeText(text).then(()=>showMsg('Đã sao chép ID'));
  }else{
    const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); showMsg('Đã sao chép ID'); }catch{}
    document.body.removeChild(ta);
  }
}
function showMsg(s){ const el=document.getElementById('msg'); if(!el) return; el.textContent=s; setTimeout(()=>{ if(el.textContent===s) el.textContent=''; },1500); }

/* ===== Profile ===== */
async function loadProfile(){
  try{
    const res=await apiFetch('/api/user/getProfile',{method:'POST',headers:{'Authorization':`Bearer ${token}`}});
    const js=await res.json();
    if(js.status && js.data){
      const real=document.getElementById('real-balance'), demo=document.getElementById('demo-balance');
      if(real) real.textContent=(js.data.balance||0).toLocaleString('vi-VN');
      if(demo) demo.textContent=(js.data.demoBalance||0).toLocaleString('vi-VN');
    }else redirectLogin();
  }catch(e){ if(e.message!=='Unauthorized') console.error(e); }
}
loadProfile(); setInterval(loadProfile, 1000);

/* ===== Menu ===== */
const body=document.body, sidebar=document.getElementById('sidebar'), backdrop=document.getElementById('backdrop'), btnMenu=document.getElementById('btn-menu');
function openMenu(){ sidebar.classList.add('show'); backdrop.classList.add('show'); body.classList.add('noscroll'); }
function closeMenu(){ sidebar.classList.remove('show'); backdrop.classList.remove('show'); body.classList.remove('noscroll'); }
btnMenu.addEventListener('click', ()=> sidebar.classList.contains('show')?closeMenu():openMenu());
backdrop.addEventListener('click', closeMenu);
document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeMenu(); });

/* Logout */
document.getElementById('btn-logout').onclick = async ()=>{ try{ await apiFetch('/api/logout',{method:'POST'});}catch{} redirectLogin(); };

/* ===== Advice (CSS loader only, anti-jitter) ===== */
const elAdviceImg   = document.getElementById('advice-img');
const elAdviceGuide = document.getElementById('advice-guide');
const elAdviceSide  = document.getElementById('advice-side');
const elAdviceSpin  = document.getElementById('advice-spin');
let currentAdviceMode = null; // 'WAIT' | 'BUY' | 'SELL'

/* Preload BUY/SELL */
const _preBuy = new Image(); _preBuy.src = MEDIA.BUY;
const _preSell = new Image(); _preSell.src = MEDIA.SELL;

function showSpinner(v){ elAdviceSpin.classList.toggle('advice-hidden', !v); }

function showWait(){
  if(currentAdviceMode==='WAIT') return;
  currentAdviceMode='WAIT';
  elAdviceGuide.classList.add('advice-hidden');
  elAdviceImg.classList.add('advice-hidden');
  showSpinner(true);
}

function showEntry(side){
  const mode = (side||'').toLowerCase()==='sell' ? 'SELL' : 'BUY';
  if(currentAdviceMode===mode) return; // không đổi DOM để tránh giật
  currentAdviceMode=mode;
  elAdviceSide.textContent = mode;
  const nextSrc = mode==='BUY' ? MEDIA.BUY : MEDIA.SELL;
  if(elAdviceImg.src !== nextSrc) elAdviceImg.src = nextSrc;
  showSpinner(false);
  elAdviceImg.classList.remove('advice-hidden');
  elAdviceGuide.classList.remove('advice-hidden');
}

/* Ratio helpers */
const elRatio=document.getElementById('ratio');
function setRatio(v){ if(typeof v==='number' && v>0){ elRatio.textContent=`Ratio: ${v}%`; elRatio.classList.remove('hidden'); } else elRatio.classList.add('hidden'); }
async function ensureServerRatio(windowId){ try{ const r=await apiFetch(`/api/ratio?window_id=${encodeURIComponent(windowId)}`); const j=await r.json(); return j.ok?(j.ratio||70):70; }catch{return 70;} }

function applyState(s){
  if(s?.is_entry_window){
    showEntry(s.suggest==='sell'?'sell':'buy');
    if(typeof s.ratio==='number') setRatio(s.ratio); else ensureServerRatio(s.window_id||'').then(setRatio);
    lockButtons(false);
  }else{
    showWait();
    setRatio(null);
    lockButtons(true);
  }
}

/* ===== Auto fit tables ===== */
function shrinkTableToFit(selector){
  const t=document.querySelector(selector);
  if(!t) return;
  t.classList.remove('small-1','small-2','small-3','small-4');
  const hasOverflow = () => [...t.querySelectorAll('tbody td')].some(td => td.scrollWidth > td.clientWidth);
  if(hasOverflow()) t.classList.add('small-1');
  if(hasOverflow()) t.classList.add('small-2');
  if(hasOverflow()) t.classList.add('small-3');
  if(hasOverflow()) t.classList.add('small-4');
}
function fitAllTables(){
  shrinkTableToFit('#pending-table');
  shrinkTableToFit('#hist-table');
}
window.addEventListener('resize', fitAllTables);

/* ===== Render helpers ===== */
function rowSidePill(side){
  const s=(side||'').toLowerCase();
  if(s==='buy')  return '<span class="pill-up">BUY</span>';
  if(s==='sell') return '<span class="pill-dn">SELL</span>';
  return side||'';
}

/* ===== Polling ===== */
let inflightS=null,inflightP=null,inflightH=null;
let pollStateTimer=null,pollPendingTimer=null,pollHistoryTimer=null;

/* State */
async function refreshState(){
  if(inflightS){ try{ inflightS.abort(); }catch{} }
  inflightS=new AbortController();
  try{
    const res=await apiFetch('/api/state', Object.assign(withAuth(), {signal:inflightS.signal}));
    const js=await res.json();
    if(js.ok) applyState(js.state||{}); else if(js.code===401) redirectLogin();
  }catch(e){ if(e.name!=='AbortError'&&e.message!=='Unauthorized') console.error('State error',e); }
}

/* Pending */
async function refreshPending(){
  if(inflightP){ try{ inflightP.abort(); }catch{} }
  inflightP=new AbortController();
  try{
    const type_mode=document.getElementById('type_mode').value;
    const res=await apiFetch('/api/pending?type_mode='+encodeURIComponent(type_mode), Object.assign(withAuth(), {signal:inflightP.signal}));
    const js=await res.json();
    const body=document.getElementById('pending-body'); body.innerHTML='';
    if(!js.ok){
      if(js.code===401){redirectLogin();return;}
      body.innerHTML='<tr><td colspan="5" class="center muted">Không tải được</td></tr>'; fitAllTables(); return;
    }
    const rows=js.rows||[];
    if(rows.length===0){ body.innerHTML='<tr><td colspan="5" class="center muted">Không có lệnh chờ</td></tr>'; fitAllTables(); return; }
    for(const r of rows){
      const t = compactTime(r.time);
      const idFull = r.idChart ?? '';
      const idShort = shortId(idFull);
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${t}</td>
        <td class="center">${rowSidePill(r.side)}</td>
        <td class="center">$${money(r.amount)}</td>
        <td class="center">${r.status||''}</td>
        <td class="mono center id-cell"><span class="copyable" title="Nhấn để copy" data-full="${String(idFull).replace(/"/g,'&quot;')}">${idShort}</span></td>`;
      body.appendChild(tr);
    }
    fitAllTables();
  }catch(e){ if(e.name!=='AbortError'&&e.message!=='Unauthorized') console.error('Pending error',e); }
}

/* History */
async function refreshHistory(){
  if(inflightH){ try{ inflightH.abort(); }catch{} }
  inflightH=new AbortController();
  try{
    const type_mode=document.getElementById('type_mode').value;
    const res=await apiFetch('/api/history?type_mode='+encodeURIComponent(type_mode), Object.assign(withAuth(), {signal:inflightH.signal}));
    const js=await res.json();
    const body=document.getElementById('hist-body'); body.innerHTML='';
    if(!js.ok){
      if(js.code===401){redirectLogin();return;}
      body.innerHTML='<tr><td colspan="5" class="center muted">Không tải được</td></tr>'; fitAllTables(); return;
    }
    const rows=js.rows||[];
    if(rows.length===0){ body.innerHTML='<tr><td colspan="5" class="center muted">Chưa có dữ liệu</td></tr>'; fitAllTables(); return; }
    for(const r of rows){
      let pnl='';
      if(r.status==='PENDING' || r.pnl==null) pnl='<span class="muted">Đang chờ…</span>';
      else pnl = (r.pnl>0) ? `<span class="pnl-pos">+${money(r.pnl)}</span>` : (r.pnl<0) ? `<span class="pnl-neg">${money(r.pnl)}</span>` : '0.00';
      const t = compactTime(r.time);
      const idFull = r.idChart ?? '';
      const idShort = shortId(idFull);
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${t}</td>
        <td class="center">${rowSidePill(r.side)}</td>
        <td class="center">$${money(r.amount)}</td>
        <td class="center">${pnl}</td>
        <td class="mono center id-cell"><span class="copyable" title="Nhấn để copy" data-full="${String(idFull).replace(/"/g,'&quot;')}">${idShort}</span></td>`;
      body.appendChild(tr);
    }
    fitAllTables();
  }catch(e){ if(e.name!=='AbortError'&&e.message!=='Unauthorized') console.error('History error',e); }
}

/* Copy full ID on click */
document.addEventListener('click', (ev)=>{
  const t=ev.target.closest('.copyable');
  if(!t) return;
  copyText(t.getAttribute('data-full'));
});

/* Orders */
function lockButtons(b){ [document.getElementById('btn-buy'),document.getElementById('btn-sell')].forEach(x=>x.classList.toggle('btn-blocked', b)); }
async function sendOrder(side){
  const msg=document.getElementById('msg');
  const amount=Math.max(0, toNum(document.getElementById('amount').value));
  const type_mode=document.getElementById('type_mode').value;
  if(!amount){ msg.textContent='Vui lòng nhập số tiền hợp lệ.'; return; }
  msg.textContent='Đang gửi lệnh...';
  try{
    const res=await apiFetch('/api/order', withAuth({method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({side,amount,type_mode})}));
    const js=await res.json();
    if(js.status===true){
      const d=js.data||{};
      msg.textContent=`Đặt lệnh ${side.toUpperCase()} $${money(amount)} thành công.`+(d.balance!=null?` Số dư: $${money(d.balance)}.`:'');
      refreshPending(); loadProfile();
    }else{
      if(js.code===401){redirectLogin();return;}
      msg.textContent=js.message||js.user_msg||'Đặt lệnh thất bại.';
    }
  }catch(e){ if(e.message!=='Unauthorized') msg.textContent='Lỗi mạng, vui lòng thử lại.'; }
}

/* Bind */
document.getElementById('type_mode').onchange = ()=>{ refreshPending(); refreshHistory(); };
document.getElementById('btn-buy').onclick  = ()=>sendOrder('buy');
document.getElementById('btn-sell').onclick = ()=>sendOrder('sell');

/* Cleanup */
window.addEventListener('beforeunload', ()=>{
  [inflightS,inflightP,inflightH].forEach(c=>{try{c?.abort();}catch{}});
  [pollStateTimer,pollPendingTimer,pollHistoryTimer].forEach(t=>{ if(t) clearInterval(t); });
});

/* Loops */
function startLoops(){
  refreshState(); refreshPending(); refreshHistory();
  pollStateTimer=setInterval(refreshState,2000);
  pollPendingTimer=setInterval(refreshPending,3000);
  pollHistoryTimer=setInterval(refreshHistory,8000);
  fitAllTables();
}
startLoops();
</script>
</body>
</html>
