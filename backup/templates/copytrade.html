<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" />
<title>Copytrade — BO Helper</title>
<style>
:root{
  --bg:#0b1320; --bg2:#0a1223;
  --card:#0f1f35; --card2:#102645;
  --accent:#2dd4bf; --brand:#34c759; --sell:#ff4d4f;
  --muted:#9aa3ab; --text:#eaf2ff; --text-soft:#cfe0ff;
  --line:#183558; --radius:16px
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  background:linear-gradient(180deg,var(--bg),var(--bg2));
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  position: relative;
  overflow-x: hidden;
}

/* Advanced 3D animated background with multiple layers */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: 
    radial-gradient(circle at 25% 75%, rgba(45, 212, 191, 0.12) 0%, transparent 60%),
    radial-gradient(circle at 75% 25%, rgba(52, 199, 89, 0.09) 0%, transparent 60%),
    radial-gradient(circle at 50% 50%, rgba(255, 77, 79, 0.07) 0%, transparent 60%),
    radial-gradient(circle at 15% 15%, rgba(138, 43, 226, 0.05) 0%, transparent 60%),
    radial-gradient(circle at 85% 85%, rgba(255, 140, 66, 0.04) 0%, transparent 60%);
  animation: floatingParticles3D 38s ease-in-out infinite;
  pointer-events: none;
  z-index: 0;
}

@keyframes floatingParticles3D {
  0%, 100% { 
    transform: translateY(0px) translateX(0px) rotate(0deg) scale(1);
    filter: blur(0px) hue-rotate(0deg) brightness(1);
  }
  20% { 
    transform: translateY(-25px) translateX(18px) rotate(2.2deg) scale(1.06);
    filter: blur(0.7px) hue-rotate(72deg) brightness(1.12);
  }
  40% { 
    transform: translateY(20px) translateX(-25px) rotate(-1.8deg) scale(0.94);
    filter: blur(1.3px) hue-rotate(144deg) brightness(0.88);
  }
  60% { 
    transform: translateY(-18px) translateX(22px) rotate(1.6deg) scale(1.04);
    filter: blur(0.5px) hue-rotate(216deg) brightness(1.08);
  }
  80% { 
    transform: translateY(12px) translateX(-12px) rotate(-1.2deg) scale(0.98);
    filter: blur(0.3px) hue-rotate(288deg) brightness(0.92);
  }
}

/* Floating 3D geometric shapes */
body::after {
  content: '';
  position: fixed;
  top: 18%;
  right: 10%;
  width: 160px;
  height: 160px;
  background: conic-gradient(from 30deg, 
    rgba(45, 212, 191, 0.28), 
    rgba(52, 199, 89, 0.18), 
    rgba(255, 77, 79, 0.12), 
    rgba(138, 43, 226, 0.22), 
    rgba(255, 140, 66, 0.08),
    rgba(45, 212, 191, 0.28));
  border-radius: 42% 58% 78% 22% / 28% 48% 72% 52%;
  animation: morphingShape3D 32s ease-in-out infinite;
  pointer-events: none;
  z-index: 0;
}

@keyframes morphingShape3D {
  0%, 100% { 
    border-radius: 42% 58% 78% 22% / 28% 48% 72% 52%;
    transform: rotate(0deg) scale(1) rotateX(0deg) rotateY(0deg);
    opacity: 0.75;
    filter: blur(0px);
  }
  14% { 
    border-radius: 68% 32% 88% 12% / 88% 58% 42% 12%;
    transform: rotate(50deg) scale(1.35) rotateX(18deg) rotateY(12deg);
    opacity: 0.95;
    filter: blur(1px);
  }
  28% { 
    border-radius: 52% 48% 38% 62% / 38% 78% 22% 62%;
    transform: rotate(100deg) scale(0.65) rotateX(-12deg) rotateY(22deg);
    opacity: 0.45;
    filter: blur(2.2px);
  }
  42% { 
    border-radius: 78% 22% 58% 42% / 68% 32% 68% 32%;
    transform: rotate(150deg) scale(1.15) rotateX(22deg) rotateY(-18deg);
    opacity: 0.85;
    filter: blur(0.7px);
  }
  56% { 
    border-radius: 32% 68% 52% 48% / 82% 18% 82% 18%;
    transform: rotate(200deg) scale(0.85) rotateX(-8deg) rotateY(8deg);
    opacity: 0.65;
    filter: blur(1.6px);
  }
  70% { 
    border-radius: 58% 42% 72% 28% / 48% 68% 32% 52%;
    transform: rotate(250deg) scale(1.08) rotateX(8deg) rotateY(-4deg);
    opacity: 0.72;
    filter: blur(0.9px);
  }
  84% { 
    border-radius: 25% 75% 48% 52% / 78% 22% 78% 22%;
    transform: rotate(300deg) scale(0.92) rotateX(-15deg) rotateY(15deg);
    opacity: 0.58;
    filter: blur(1.4px);
  }
}

/* Additional floating orbs for copytrade */
.wrap::before {
  content: '';
  position: absolute;
  top: -40px;
  left: -40px;
  width: 90px;
  height: 90px;
  background: radial-gradient(circle at 35% 35%, rgba(255, 140, 66, 0.18), transparent);
  border-radius: 50%;
  animation: floatOrb1 22s ease-in-out infinite;
  pointer-events: none;
  z-index: 0;
}

.wrap::after {
  content: '';
  position: absolute;
  bottom: -25px;
  right: -25px;
  width: 70px;
  height: 70px;
  background: radial-gradient(circle at 65% 65%, rgba(138, 43, 226, 0.12), transparent);
  border-radius: 50%;
  animation: floatOrb2 28s ease-in-out infinite reverse;
  pointer-events: none;
  z-index: 0;
}

@keyframes floatOrb1 {
  0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.7; }
  33% { transform: translate(25px, -15px) scale(1.15); opacity: 0.9; }
  66% { transform: translate(-15px, 20px) scale(0.85); opacity: 0.5; }
}

@keyframes floatOrb2 {
  0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.6; }
  50% { transform: translate(-20px, 12px) scale(0.75); opacity: 0.85; }
}
.hidden{display:none!important}
.noscroll{overflow:hidden}

/* ===== HEADER ===== */
.main-header{
  position:fixed; top:0; left:0; right:0; height:56px;
  background:var(--bg); border-bottom:1px solid var(--line);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 14px; z-index:110;
}
.wrap{max-width:560px;margin:12px auto 84px;padding:56px 14px 0;position:relative;z-index:1}
.icon-btn{
  position:relative; width:34px; height:34px; border:none;
  background:#1a2a40; border-radius:10px; cursor:pointer;
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; padding:6px 0;
}
.icon-btn span{display:block; width:20px; height:2px; background:#fff; border-radius:2px}
.header-user-info{display:flex; align-items:center; gap:12px}
.balance-item{display:flex; align-items:center; gap:8px; background:var(--card); padding:8px 12px; border-radius:12px; border:1px solid var(--line)}
.wallet-icon{width:20px; height:20px; color:var(--muted)}
.balance-value{font-size:14px; font-weight:700; color:var(--text)}
.balance-label{font-size:11px; color:var(--muted); margin-top:-2px}
.user-profile{display:flex; align-items:center}
.avatar{width:32px;height:32px;border-radius:50%;overflow:hidden;border:2px solid var(--line);box-sizing:border-box}
.avatar img{width:100%; height:100%; object-fit:cover}
@media (max-width:420px){
  .balance-label{display:none}
  .balance-value{font-size:13px}
  .header-user-info{gap:8px}
}
@media (min-width:768px){
  .header-user-info{margin-left:auto}
}

/* ===== Sidebar ===== */
.backdrop{position:fixed; inset:0; background:rgba(0,0,0,.45); opacity:0; pointer-events:none; transition:opacity .25s ease; z-index:140}
.backdrop.show{opacity:1; pointer-events:auto}
.sidebar{
  position:fixed; top:0; left:0; height:100dvh; width:84vw; max-width:320px;
  background:#0f1b2b; border-right:1px solid #173152;
  transform:translateX(-100%); transition:transform .25s ease;
  z-index:145; display:flex; flex-direction:column; gap:12px;
  padding:calc(env(safe-area-inset-top,0px) + 14px) 14px 18px;
}
.sidebar.show{transform:translateX(0)}
.menu-item{
  display:block; width:100%; padding:12px 14px; border-radius:14px;
  background:#213247; color:#e8f2ff; font-weight:800; text-decoration:none; border:1px solid #2a3f5e
}
.menu-logout{background:#2a3b54; color:#ffd9d9}

/* ===== Cards / Forms ===== */
.card{
  background:linear-gradient(180deg,var(--card),var(--card2));
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:18px;
  box-shadow:0 12px 40px rgba(0,0,0,.35);
  position: relative;
  overflow: hidden;
  backdrop-filter: blur(10px);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  animation: cardFadeIn 0.6s ease-out;
}

@keyframes cardFadeIn {
  0% {
    opacity: 0;
    transform: translateY(20px) scale(0.95);
  }
  100% {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(45, 212, 191, 0.08), transparent);
  animation: cardShimmer 5s infinite;
  pointer-events: none;
}

@keyframes cardShimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 20px 60px rgba(0,0,0,.45), 0 0 0 1px rgba(45, 212, 191, 0.1);
  border-color: rgba(45, 212, 191, 0.3);
}
.section-title{font-weight:800;margin-bottom:10px}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;background:#0d2749;color:#b7c3cf;font-weight:700;font-size:12px}
.row{display:flex;gap:12px;align-items:center}
.col{flex:1}
label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
input,select{
  width:100%;height:46px;border-radius:12px;border:1px solid #1d334f;
  background:#091a2d;color:#fff;padding:0 12px;font-size:16px;outline:none
}
button{
  width:100%;height:48px;border-radius:14px;border:0;color:#fff;
  font-size:16px;font-weight:800;cursor:pointer;transition:.16s transform
}
button:active{transform:scale(.985)}
.btn-primary{background:linear-gradient(180deg,#36c4e8,#2aa7cb)}
.btn-flat{height:44px;background:#2a3b54;color:#e2eeff;border-radius:12px;font-weight:800}
.btn-danger{height:40px;background:#6b2a2a}
.btn-ghost{height:40px;background:#213247}

/* ===== Status pill ===== */
.status{display:inline-flex;align-items:center;gap:8px;font-weight:800;font-size:13px;padding:6px 10px;border-radius:999px;border:1px solid #2a3f5e;background:#122238;color:#bfe7ff}
.status-dot{width:8px;height:8px;border-radius:50%}
.status-on{background:#2dd4bf}
.status-off{background:#ff6b6b}
.status-label{display:inline-block}

/* ===== Config list ===== */
.cfg-item{border:1px solid #1d334f;border-radius:14px;padding:12px;margin-top:10px;background:#0c1a2c}
.cfg-head{display:flex;gap:8px;align-items:center;justify-content:space-between}
.cfg-name{font-weight:900}
.cfg-meta{font-size:12px;color:#cfe0ff;margin-top:6px;display:flex;flex-wrap:wrap;gap:10px}
.cfg-actions{display:flex;gap:8px;margin-top:10px}
.small{font-size:12px;color:#a8c3df}
.msg{color:#cfe0ff;font-size:13px;margin-top:8px;min-height:18px}
.err{color:#ff9c9c;font-size:12px;margin-top:6px;min-height:16px}

/* ===== Toggle (switch) ===== */
.switch{position:relative;width:54px;height:30px;background:#314460;border-radius:999px;border:1px solid #2a3f5e;cursor:pointer;flex:0 0 auto}
.switch input{display:none}
.switch .dot{position:absolute;top:3px;left:3px;width:24px;height:24px;border-radius:50%;background:#d0ddf0;transition:left .2s ease,background .2s ease}
.switch input:checked + .dot{left:27px;background:#9ff5e9}
.switch.on{background:#0e6b61;border-color:#13877e}

/* ===== Responsive ===== */
@media (max-width:600px){
  .row{flex-direction:column}
}
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header class="main-header">
  <button class="icon-btn" id="btn-menu" aria-label="Mở/đóng menu" aria-controls="sidebar" aria-expanded="false">
    <span></span><span></span><span></span>
  </button>
  <div class="header-user-info">
    <div class="balance-item">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" class="wallet-icon"><path d="M22 12v5c0 3-2 5-5 5H7c-3 0-5-2-5-5v-5c0-2.72 1.64-4.62 4.19-4.94.26-.04.53-.06.81-.06h10c.26 0 .51.01.75.05C20.33 7.35 22 9.26 22 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M17.751 7.05c-.24-.04-.49-.05-.75-.05h-10c-.28 0-.55.02-.81.06.14-.28.34-.54.58-.78l3.25-3.26a3.525 3.525 0 0 1 4.96 0l1.75 1.77c.64.63.98 1.43 1.02 2.26ZM22 12.5h-3c-1.1 0-2 .9-2 2s.9 2 2 2h3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div>
        <div class="balance-value">$<span id="real-balance">0</span></div>
        <div class="balance-label">TK Thực</div>
      </div>
    </div>

    <div class="balance-item">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" class="wallet-icon"><path d="M22 12v5c0 3-2 5-5 5H7c-3 0-5-2-5-5v-5c0-2.72 1.64-4.62 4.19-4.94.26-.04.53-.06.81-.06h10c.26 0 .51.01.75.05C20.33 7.35 22 9.26 22 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M17.751 7.05c-.24-.04-.49-.05-.75-.05h-10c-.28 0-.55.02-.81.06.14-.28.34-.54.58-.78l3.25-3.26a3.525 3.525 0 0 1 4.96 0l1.75 1.77c.64.63.98 1.43 1.02 2.26ZM22 12.5h-3c-1.1 0-2 .9-2 2s.9 2 2 2h3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div>
        <div class="balance-value">$<span id="demo-balance">0</span></div>
        <div class="balance-label">TK Demo</div>
      </div>
    </div>

    <div class="user-profile balance-item">
      <div class="avatar">
        <img src="https://img.favpng.com/17/24/10/computer-icons-user-profile-male-avatar-png-favpng-jhVtWQQbMdbcNCahLZztCF5wk.jpg" alt="Avatar">
      </div>
    </div>
  </div>
</header>

<!-- ===== Sidebar ===== -->
<div id="backdrop" class="backdrop" aria-hidden="true"></div>
<nav class="sidebar" id="sidebar" aria-label="Menu">
  <a href="/" class="menu-item">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="margin-right:8px">
      <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
    </svg>
    Bảng Điều Khiển
  </a>
  <a href="/aidudoan" class="menu-item">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="margin-right:8px">
      <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"/>
    </svg>
    AI Dự Đoán
  </a>
  <a href="/top-expert" class="menu-item">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="margin-right:8px">
      <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
    </svg>
    Top Chuyên Gia
  </a>
  <a href="/copytrade" class="menu-item">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="margin-right:8px">
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
    </svg>
    Copytrade
  </a>
  <button class="menu-item menu-logout" id="btn-logout" type="button">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="margin-right:8px">
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/>
    </svg>
    Đăng xuất
  </button>
</nav>

<!-- ===== PAGE ===== -->
<div class="wrap">
  <!-- Card trạng thái -->
  <div class="card" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
    <div class="badge">Copytrade đang chạy trên <b>máy chủ</b></div>
    <div class="status" id="srv-pill" title="Trạng thái dịch vụ">
      <span class="status-dot status-off" id="srv-dot"></span>
      <span class="status-label" id="srv-text">Đang kiểm tra…</span>
    </div>
  </div>

  <!-- Form thêm/sửa cấu hình -->
  <div class="card" style="margin-top:12px">
    <div class="section-title">Thêm / Sửa cấu hình</div>

    <div class="row">
      <div class="col">
        <label for="cfg-name">Tên cấu hình</label>
        <input id="cfg-name" type="text" placeholder="Ví dụ: Chiến lược A" />
        <div id="err-name" class="err"></div>
      </div>
      <div class="col">
        <label for="cfg-type">Loại tài khoản</label>
        <select id="cfg-type">
          <option value="live" selected>live</option>
          <option value="demo">demo</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="col">
        <label for="cfg-expert">Chuyên gia</label>
        <input id="cfg-expert" type="text" placeholder="Tên chuyên gia">
      </div>
      <div class="col">
        <label for="cfg-so-tien-co-dinh">Số tiền cố định mỗi lệnh ($)</label>
        <input id="cfg-so-tien-co-dinh" type="number" step="0.01" min="0" value="10" inputmode="decimal">
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="col">
        <label for="cfg-so-von">Vốn Copytrade ($)</label>
        <input id="cfg-so-von" type="number" step="0.01" min="0" value="100" inputmode="decimal">
        <div id="err-so-von" class="err"></div>
      </div>
      <div class="col">
        <label for="cfg-so-tien-tai-khoan">Số dư tài khoản ($)</label>
        <input id="cfg-so-tien-tai-khoan" type="number" step="0.01" min="0" value="1000" inputmode="decimal">
        <div id="err-so-tien-tai-khoan" class="err"></div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="col">
        <label for="cfg-tp">Chốt lãi ($)</label>
        <input id="cfg-tp" type="number" step="0.01" min="0" value="100" inputmode="decimal">
      </div>
      <div class="col">
        <label for="cfg-sl">Dừng lỗ ($)</label>
        <input id="cfg-sl" type="number" step="0.01" min="0" value="100" inputmode="decimal">
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="col"></div>
      <div class="col" style="display:flex;gap:10px;align-items:end;justify-content:end">
        <button id="btn-save" class="btn-primary" type="button">Lưu cấu hình</button>
        <button id="btn-reset" class="btn-flat" type="button">Reset form</button>
      </div>
    </div>

    <div class="msg" id="cfg-msg"></div>
    <div class="small" style="margin-top:6px">
      Quy tắc: <b>Luôn đặt số tiền cố định</b>, không phụ thuộc số tiền chuyên gia. Vốn sẽ tự động quản lý.
    </div>
  </div>

  <!-- Quản lý cấu hình -->
  <div class="card" style="margin-top:12px">
    <div class="section-title">Quản lý cấu hình</div>
    <div id="cfg-list"></div>
  </div>
</div>

<script>
/* ===== Auth ===== */
const params = new URLSearchParams(window.location.search);
const token = localStorage.getItem('token') || params.get('token');
if(!token){ location.replace('/login'); } else { localStorage.setItem('token', token); }

/* ===== Auth Helper ===== */
function redirectToLogin() {
  localStorage.removeItem('token');
  sessionStorage.clear();
  location.replace('/login');
}

async function checkAuthAndFetch(url, options = {}) {
  try {
    const response = await fetch(url, options);
    if (response.status === 401) {
      redirectToLogin();
      throw new Error('Session expired');
    }
    return response;
  } catch (error) {
    throw error;
  }
}

/* ===== Helpers ===== */
const withAuth = (opt={})=>{
  opt.headers = Object.assign({
    'X-Token': token,
    'Authorization': `Bearer ${token}`
  }, opt.headers||{});
  return opt;
};
function money(n){ return (Number(n)||0).toFixed(2); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* ===== Load balances only ===== */
async function loadProfile(){
  try{
    const res = await checkAuthAndFetch('/api/user/getProfile', {
      method:'POST',
      headers:{ 'Authorization':`Bearer ${token}` }
    });
    const js = await res.json();
    if(js.status && js.data){
      const real = document.getElementById('real-balance');
      const demo = document.getElementById('demo-balance');
      if(real) real.textContent = (js.data.balance||0).toLocaleString();
      if(demo) demo.textContent = (js.data.demoBalance||0).toLocaleString();
    } else if (!js.status) {
      redirectToLogin();
    }
  }catch(e){
    if (e.message !== 'Session expired') {
      console.error('loadProfile failed:', e);
    }
  }
}
loadProfile(); setInterval(loadProfile, 30000);

/* ===== Sidebar ===== */
const body = document.body;
const sidebar = document.getElementById('sidebar');
const backdrop = document.getElementById('backdrop');
const btnMenu  = document.getElementById('btn-menu');

function openMenu(){
  if(!sidebar || !backdrop || !btnMenu) return;
  sidebar.classList.add('show'); backdrop.classList.add('show'); body.classList.add('noscroll');
  btnMenu.setAttribute('aria-expanded','true'); backdrop.setAttribute('aria-hidden','false');
}
function closeMenu(){
  if(!sidebar || !backdrop || !btnMenu) return;
  sidebar.classList.remove('show'); backdrop.classList.remove('show'); body.classList.remove('noscroll');
  btnMenu.setAttribute('aria-expanded','false'); backdrop.setAttribute('aria-hidden','true');
}
function toggleMenu(){
  if(!sidebar) return;
  if(sidebar.classList.contains('show')) closeMenu(); else openMenu();
}
if(btnMenu){ btnMenu.addEventListener('click', toggleMenu); }
if(backdrop){ backdrop.addEventListener('click', closeMenu); }
document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeMenu(); });

/* ===== Logout ===== */
const btnLogout = document.getElementById('btn-logout');
if(btnLogout){
  btnLogout.onclick = async ()=>{
    try{ await fetch('/api/logout',{method:'POST'}); }catch(e){}
    redirectToLogin();
  };
}

/* ===== Service status pill ===== */
const srvDot = document.getElementById('srv-dot');
const srvText = document.getElementById('srv-text');
function setSrvStatus(on, text){
  if(!srvDot || !srvText) return;
  srvDot.classList.toggle('status-on', !!on);
  srvDot.classList.toggle('status-off', !on);
  srvText.textContent = text || (on ? 'Đang chạy' : 'Đang tắt');
}
async function pollService(){
  try{
    const r = await checkAuthAndFetch('/api/copytrade/status', withAuth());
    const js = await r.json();
    const on = (js.enabled===true) || (/on|running|true/i.test(String(js.status)));
    setSrvStatus(on);
  }catch(e){
    if (e.message !== 'Session expired') {
      setSrvStatus(false,'Mất kết nối');
    }
  }
}
pollService(); setInterval(pollService, 4000);

/* ===== Local storage for configs ===== */
const CFGS_KEY = 'copytrade_cfgs_v1';
let editingId = null;
function loadCfgs(){ try{ return JSON.parse(localStorage.getItem(CFGS_KEY)||'[]'); }catch(e){ return []; } }
function saveCfgs(arr){ localStorage.setItem(CFGS_KEY, JSON.stringify(arr)); }
function uniqId(){ return 'cfg_' + Date.now() + '_' + Math.random().toString(36).slice(2,6); }
function upsertCfg(cfg){
  const all = loadCfgs();
  if(!cfg.id) cfg.id = uniqId();
  const i = all.findIndex(x=>x.id===cfg.id);
  if(i>=0) all[i]=cfg; else all.push(cfg);
  saveCfgs(all);
  return cfg.id;
}
function deleteCfg(id){
  const all = loadCfgs().filter(x=>x.id!==id);
  saveCfgs(all);
}

/* ===== Form helpers ===== */
function resetForm(){
  editingId = null;
  document.getElementById('cfg-name').value = '';
  document.getElementById('cfg-type').value = 'live';
  document.getElementById('cfg-expert').value = '';
  document.getElementById('cfg-so-tien-co-dinh').value = '10';
  document.getElementById('cfg-so-von').value = '100';
  document.getElementById('cfg-so-tien-tai-khoan').value = '1000';
  document.getElementById('cfg-tp').value = '100';
  document.getElementById('cfg-sl').value = '100';
  document.getElementById('cfg-msg').textContent = '';
  document.getElementById('err-name').textContent = '';
  document.getElementById('err-so-von').textContent = '';
  document.getElementById('err-so-tien-tai-khoan').textContent = '';
}
function fillFormFromCfg(cfg){
  editingId = cfg.id;
  document.getElementById('cfg-name').value = cfg.name||'';
  document.getElementById('cfg-type').value = cfg.type||'live';
  document.getElementById('cfg-expert').value = cfg.expert||'';
  document.getElementById('cfg-so-tien-co-dinh').value = cfg.so_tien_co_dinh ?? 10;
  document.getElementById('cfg-so-von').value = cfg.so_von ?? 100;
  document.getElementById('cfg-so-tien-tai-khoan').value = cfg.so_tien_tai_khoan ?? 1000;
  document.getElementById('cfg-tp').value = cfg.tp ?? 100;
  document.getElementById('cfg-sl').value = cfg.sl ?? 100;
}
function readCfgFromForm(){
  return {
    id: editingId,
    name: document.getElementById('cfg-name').value.trim(),
    type: document.getElementById('cfg-type').value,
    expert: document.getElementById('cfg-expert').value.trim(),
    so_tien_co_dinh: Number(document.getElementById('cfg-so-tien-co-dinh').value || 0),
    so_von: Number(document.getElementById('cfg-so-von').value || 0),
    so_tien_tai_khoan: Number(document.getElementById('cfg-so-tien-tai-khoan').value || 0),
    tp: Number(document.getElementById('cfg-tp').value || 0),
    sl: Number(document.getElementById('cfg-sl').value || 0),
    enabled: false
  };
}
function validateCfg(cfg){
  let ok=true;
  const erN=document.getElementById('err-name');
  const erV=document.getElementById('err-so-von');
  const erT=document.getElementById('err-so-tien-tai-khoan');
  
  erN.textContent=''; erV.textContent=''; erT.textContent='';
  
  if(!cfg.name){ erN.textContent='Tên cấu hình không được để trống'; ok=false; }
  if(!(cfg.so_tien_co_dinh>0)){ erN.textContent='Số tiền cố định phải > 0'; ok=false; }
  if(!(cfg.so_von>0)){ erV.textContent='Vốn copytrade phải > 0'; ok=false; }
  if(!(cfg.so_tien_tai_khoan>0)){ erT.textContent='Số dư tài khoản phải > 0'; ok=false; }
  if(cfg.so_tien_co_dinh > cfg.so_von){ erV.textContent='Số tiền cố định không được lớn hơn vốn'; ok=false; }
  if(cfg.so_von > cfg.so_tien_tai_khoan){ erT.textContent='Vốn copytrade không được lớn hơn số dư'; ok=false; }
  
  return ok;
}

/* ===== Server endpoints ===== */
async function startCopytrade(cfg){
  const res = await checkAuthAndFetch('/api/copytrade/start', withAuth({
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(cfg)
  }));
  return res.json();
}
async function stopCopytradeGlobal(){
  const res = await checkAuthAndFetch('/api/copytrade/stop', withAuth({method:'POST'}));
  return res.json();
}
// Nếu backend có stop theo id, đổi nội dung hàm dưới cho phù hợp
async function stopCopytradeOne(/*cfg*/){ return stopCopytradeGlobal(); }

/* ===== Render list ===== */
function cfgStatusPill(enabled){
  const cls = enabled ? 'status-on' : 'status-off';
  const txt = enabled ? 'ĐANG CHẠY' : 'ĐANG TẮT';
  return `<span class="status">
            <span class="status-dot ${cls}"></span>
            <span class="status-label">${txt}</span>
          </span>`;
}
function renderCfgList(){
  const wrap = document.getElementById('cfg-list');
  const all = loadCfgs();
  if(!wrap) return;
  if(all.length===0){
    wrap.innerHTML = `<div class="small">Chưa có cấu hình nào. Hãy thêm cấu hình ở form phía trên.</div>`;
    return;
  }
  all.sort((a,b)=> (b.enabled?1:0) - (a.enabled?1:0));
  wrap.innerHTML = '';
  all.forEach(cfg=>{
    const item = document.createElement('div');
    item.className = 'cfg-item';
    item.innerHTML = `
      <div class="cfg-head">
        <div>
          <div class="cfg-name">${escapeHtml(cfg.name||'(Không tên)')}</div>
          <div class="small"></div>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          ${cfgStatusPill(!!cfg.enabled)}
          <label class="switch ${cfg.enabled?'on':''}">
            <input type="checkbox" ${cfg.enabled?'checked':''} data-action="toggle" data-id="${cfg.id}">
            <span class="dot"></span>
          </label>
        </div>
      </div>
      <div class="cfg-meta">
        <span><b>Loại:</b> ${escapeHtml(cfg.type||'')}</span>
        <span><b>Chuyên gia:</b> ${escapeHtml(cfg.expert||'')}</span>
        <span><b>Số tiền cố định:</b> $${money(cfg.so_tien_co_dinh||0)}</span>
        <span><b>Vốn:</b> $${money(cfg.so_von||0)}</span>
        <span><b>Số dư TK:</b> $${money(cfg.so_tien_tai_khoan||0)}</span>
        <span><b>TP:</b> $${money(cfg.tp||0)}</span>
        <span><b>SL:</b> $${money(cfg.sl||0)}</span>
      </div>
      <div class="cfg-actions">
        <button class="btn-ghost" data-action="edit" data-id="${cfg.id}" type="button">Sửa</button>
        <button class="btn-danger" data-action="delete" data-id="${cfg.id}" type="button">Xóa</button>
      </div>
      <div class="msg" id="msg-${cfg.id}"></div>
    `;
    wrap.appendChild(item);
  });
}

/* ===== Events ===== */
const btnSave = document.getElementById('btn-save');
if(btnSave){
  btnSave.onclick = ()=>{
    const cfg = readCfgFromForm();
    if(!validateCfg(cfg)) return;
    const id = upsertCfg(cfg);
    const msg = document.getElementById('cfg-msg');
    if(msg){ msg.textContent = 'Đã lưu cấu hình.'; setTimeout(()=>msg.textContent='',1500); }
    renderCfgList();
    editingId = id;
  };
}
const btnReset = document.getElementById('btn-reset');
if(btnReset){ btnReset.onclick = resetForm; }

const cfgListEl = document.getElementById('cfg-list');
if(cfgListEl){
  cfgListEl.addEventListener('click', async (e)=>{
    const btn = e.target.closest('[data-action]');
    if(!btn) return;
    const id = btn.getAttribute('data-id');
    const action = btn.getAttribute('data-action');
    const all = loadCfgs();
    const idx = all.findIndex(x=>x.id===id);
    if(idx<0) return;
    const cfg = all[idx];
    const msgEl = document.getElementById('msg-'+id);

    if(action==='edit'){
      fillFormFromCfg(cfg);
      window.scrollTo({top:0, behavior:'smooth'});
    }else if(action==='delete'){
      if(!confirm('Xóa cấu hình này?')) return;
      if(cfg.enabled){
        if(msgEl) msgEl.textContent = 'Đang tắt copytrade trước khi xóa...';
        try{ await stopCopytradeOne(cfg); }catch(e){}
      }
      deleteCfg(id);
      renderCfgList();
    }
  });

  cfgListEl.addEventListener('change', async (e)=>{
    const inp = e.target;
    if(!(inp instanceof HTMLInputElement)) return;
    if(inp.getAttribute('data-action')!=='toggle') return;

    const id = inp.getAttribute('data-id');
    const all = loadCfgs();
    const idx = all.findIndex(x=>x.id===id);
    if(idx<0) return;
    const cfg = all[idx];
    const wrapSwitch = inp.parentElement;
    const msgEl = document.getElementById('msg-'+id);
    const card = inp.closest('.cfg-item');
    const pill = card ? card.querySelector('.status') : null;
    const pillDot = pill ? pill.querySelector('.status-dot') : null;
    const pillLabel = pill ? pill.querySelector('.status-label') : null;

    const wantEnable = inp.checked;

    // optimistic UI
    cfg.enabled = wantEnable; all[idx] = cfg; saveCfgs(all);
    if(wrapSwitch) wrapSwitch.classList.toggle('on', wantEnable);
    if(pillDot){
      pillDot.classList.toggle('status-on', wantEnable);
      pillDot.classList.toggle('status-off', !wantEnable);
    }
    if(pillLabel) pillLabel.textContent = wantEnable ? 'ĐANG CHẠY' : 'ĐANG TẮT';
    if(msgEl) msgEl.textContent = wantEnable ? 'Đang bật...' : 'Đang tắt...';

    try{
      let rsp;
      if(wantEnable){ rsp = await startCopytrade(cfg); } else { rsp = await stopCopytradeOne(cfg); }
      if(rsp && rsp.ok){
        if(msgEl) msgEl.textContent = wantEnable ? 'Đã bật copytrade.' : 'Đã tắt copytrade.';
        pollService();
      }else{
        // rollback
        cfg.enabled = !wantEnable; all[idx]=cfg; saveCfgs(all);
        inp.checked = cfg.enabled;
        if(wrapSwitch) wrapSwitch.classList.toggle('on', cfg.enabled);
        if(pillDot){
          pillDot.classList.toggle('status-on', cfg.enabled);
          pillDot.classList.toggle('status-off', !cfg.enabled);
        }
        if(pillLabel) pillLabel.textContent = cfg.enabled ? 'ĐANG CHẠY' : 'ĐANG TẮT';
        if(msgEl) msgEl.textContent = (rsp && (rsp.user_msg||rsp.error)) || 'Cập nhật thất bại.';
      }
    }catch(err){
      // rollback
      cfg.enabled = !wantEnable; all[idx]=cfg; saveCfgs(all);
      inp.checked = cfg.enabled;
      if(wrapSwitch) wrapSwitch.classList.toggle('on', cfg.enabled);
      if(pillDot){
        pillDot.classList.toggle('status-on', cfg.enabled);
        pillDot.classList.toggle('status-off', !cfg.enabled);
      }
      if(pillLabel) pillLabel.textContent = cfg.enabled ? 'ĐANG CHẠY' : 'ĐANG TẮT';
      if(msgEl) msgEl.textContent = 'Lỗi mạng. Vui lòng thử lại.';
    }
  });
}

/* ===== Init ===== */
(function init(){
  renderCfgList();
})();
</script>
</body>
</html>
